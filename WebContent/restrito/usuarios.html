<!DOCTYPE HTML>
<html lang="pt">
	<title>Cadastro Usuários</title>
	<meta charset="utf-8">
	<head>
		
	    <!-- add the jQuery script -->
	    <script type="text/javascript" src="../lib/jqWidget/scripts/jquery-1.11.1.min.js"></script>	
	    
	    <!-- add the jQWidgets framework -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxcore.js"></script>
	    
	    <!-- add one or more widgets -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxbuttons.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxmenu.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxinput.js"></script>
	    
	    <!-- combobox -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxscrollbar.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxlistbox.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxcombobox.js"></script>
	    
	    <!-- textarea -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxtextarea.js"></script>
	    
	    <!-- calendar -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxdatetimeinput.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxcalendar.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxtooltip.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/globalization/globalize.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/globalization/globalize.culture.pt-BR.js"></script>
	    
	    <!-- campos type number currency -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxnumberinput.js"></script>
	    
	    <!-- pop up window -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxwindow.js"></script>
	    
	     <!-- notification -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxnotification.js"></script>
	    
	    
	    <!-- radio button -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxradiobutton.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxbuttongroup.js"></script>
	    
	     <!-- panel -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxpanel.js"></script>
	    
	    
	    <!-- grid -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxlistbox.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxdropdownlist.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxgrid.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxgrid.pager.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxgrid.sort.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxgrid.filter.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxgrid.columnsresize.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxgrid.selection.js"></script>	    
    
    	<!-- ckeck box -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxcheckbox.js"></script>
	    
	    
	    <!-- export data -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxdata.js"></script>
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxdata.export.js"></script> 
		<script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxgrid.export.js"></script>	
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxgrid.storage.js"></script> 
	    
	    
	    <!-- scrollbar -->
	    <script type="text/javascript" src="../lib/jqWidget/jqwidgets/jqxscrollbar.js"></script>
	    
	    
	    <!-- add the jQWidgets base styles and one of the theme stylesheets -->
   	    <link rel="stylesheet" href="../lib/jqWidget/jqwidgets/styles/jqx.base.css" type="text/css" />
	    <link rel="stylesheet" href="../lib/jqWidget/jqwidgets/styles/jqx.shinyblack.css" type="text/css" />
	    <link rel="stylesheet" href="../lib/jqWidget/jqwidgets/styles/jqx.energyblue.css" type="text/css" />
	    
	    <link rel="stylesheet" href="../lib/jqWidget/jqwidgets/styles/jqx.web.css" type="text/css" />
	    
	    
	    <script type="text/javascript" src="../lib/local/jquery.blockUI.js"></script>
		<script type="text/javascript" src="../lib/local/util.js"></script>
	   
	   <script type="text/javascript" src="../lib/local/jquery.mask.min.js"></script>
	   
	   <script type="text/javascript" src="js/localization_settings.js"></script>
	   
	    <style>
			
			html, body{
				
				overflow: hidden; 
				margin: 0;
				font-family: Verdana,Arial,sans-serif;
			
			}
			
			fieldset { border:1px solid black }

			legend {
				  padding: 0.2em 0.5em;
				  border:1px solid red;
				  color:red;
				  font-size:80%;
				  text-align:center;
			  }
			
			label{

				font-family: Verdana,Arial,sans-serif;
    			font-style: normal;
    			font-size: 13px;
			    
			    
			    display: table-cell;
			    width: 150px;
			    text-align: left;
			}

		    .footer {
		    	width:100%;
		    	position:absolute;
		    	bottom:0;
			    background: #111;
			    color: #888;
			    text-align: center;
			    font-family: sans-serif
			}
		    .footer a {
		        color: #ddd;
		    }
		    
		    .l-box {
    			padding: 0.5em 2em;
			}
	    
	    </style>
	    <script>
	    	$(document).ready(function(){
	    		
	    		listarCC();
	    		listarTiposUSR();
	    		listarGruposUSR();
	    		
	    		$("#jqxMenu").jqxMenu({ width: '100%', height: '30px',theme: 'shinyblack' });
	    		
	    		$("#nome").jqxInput({height: 25, width: 200, minLength: 1});
	    		$("#login").jqxInput({height: 25, width: 200, minLength: 1,maxLength: 50});
	    		$("#senha").jqxInput({height: 25, width: 200, minLength: 8,maxLength: 100});

            	$("#ativo").jqxComboBox({selectedIndex: 0, width: 207, height: '25px'});
            	$("#tipo").jqxComboBox({selectedIndex: 0, width: 207, height: '25px'});
/*             	$("#grupo").jqxComboBox({selectedIndex: 0, width: 207, height: '25px'});
            	$("#permitir").jqxComboBox({selectedIndex: 0, width: 207, height: '25px'}); */
           	
            	$("#salvaUSR").jqxButton({width:70,height:30});
            	$("#cancelaSalvaUSR").jqxButton({width:70,height:30});
            	
            	$("div[data-app='check_cc']").jqxCheckBox({ width: 120, height: 25}).css("display","list-item").css("list-style-type","none");
	    		
            	$("div[data-app='check_gr']").jqxCheckBox({ width: 120, height: 25}).css("display","list-item").css("list-style-type","none");
            	
				function listarCC(){
					
					ajxRequestStd({returnType:"json", async:false, timeout:10000, method:"GET", url:"../ws/restrito/usuarios/listarCCcadastrados"}, 
						function(response){

						var html = "";
							for(var i = 0; i < response.length; i++){
							
								html+='<div data-app="check_cc">'+response[i].id+'</div>';
							}
							$("#listaCC").html(html);
						}
					);
				}
				
				function listarTiposUSR(){
					
					ajxRequestStd({returnType:"json", async:false, timeout:10000, method:"GET", url:"../ws/restrito/usuarios/listarTipos"}, 
						function(response){

							var html = "";
							for(var i = 0; i < response.length; i++){
							
								html+='<option value="'+response[i]+'">'+response[i]+'</option>';
							}
							$("#tipo").html(html);
						}
					);					
				}
				
				function listarGruposUSR(){
					
					ajxRequestStd({returnType:"json", async:false, timeout:10000, method:"GET", url:"../ws/restrito/usuarios/listarGrupos"}, 
						function(response){

							var html = "";
								for(var i = 0; i < response.length; i++){
								
									//html+='<option value="'+response[i]+'">'+response[i]+'</option>';
									html+='<div data-app="check_gr">'+response[i]+'</div>';
								}
								//$("#grupo").html(html);
								$("#listaGR").html(html);
						}
					);
				}
            	
				function getAllVals(){
				
					var params = {
							
						nome : $("#nome").val(),
						login : $("#login").val(),
						senha : $("#senha").val(),
						ativo : $("#ativo").val(),
						tipo : $("#tipo").val(),
						//grupo : $("#grupo").val(),
						grupos : getGRs(),
						//permitir : $("#permitir").val(),
						autorizarCCs : getCCs()
					}
					
					return jQuery.param(params);
				}
				
				
				function getCCs(){
					
					var cc = "";
					
					$("div[data-app='check_cc']").each(function(i,obj){
						
						if($(obj).jqxCheckBox('val')){
							
							cc+= $(obj).context.textContent+",";
						}
					});
					
					return cc.substring(0,cc.length-1);
				}
				
				
				function getGRs(){
					
					var gr = "";
					
					$("div[data-app='check_gr']").each(function(i,obj){
						
						if($(obj).jqxCheckBox('val')){
							
							gr+= $(obj).context.textContent+",";
						}
					});
					
					return gr.substring(0,gr.length-1);
				}
				
				
            	$("#salvaUSR").on('click', function () {
            		
					ajxRequestStd({returnType:"json", async:true, timeout:10000, method:"POST",url:"../ws/restrito/usuarios/salvar", param : getAllVals()}, 

						function(response){
							
							resetForm($("#form1"));
							
							$('#jqxgrid').jqxGrid('updatebounddata');
							
							alert(response.serverMessageUser);
						}
					);
                });
            	
            	
            	$("#cancelaSalvaUSR").on('click', function () {
            		
					resetForm("#form1");
 
            	});
            	
            	
                function resetForm(form){
                	$(form)[0].reset();
                	$("div[data-app='check_cc']").jqxCheckBox('uncheck');
                	$("div[data-app='check_gr']").jqxCheckBox('uncheck');
                }
                

                var source =
                {
                    datatype: "json",
                    url:"../ws/restrito/usuarios/listar",
                    
                    datafields: [
                        
                        { name: 'nome', type:'string'},         
                        { name: 'login', type:'string'},
                        { name: 'grupo', type:'string'},
                        { name: 'tipo', type:'string'},
                        { name: 'ativo', type:'string'},
                        //{ name: 'permitirAcesso', type:'string'},
                        { name: 'listaCC_delimitado', type: 'string'},
                        { name: 'grupos_delimitado', type: 'string'}
                    ]
                };
            	
                
                var dataAdapter = new $.jqx.dataAdapter(source,{
                	downloadComplete: function (data, status, xhr) { },
                	loadComplete: function (data) { console.log(data);},
                	loadError: function (xhr, status, error) { }
                });                
                
                $("#jqxgrid").jqxGrid(
                        {
                        	localization:localizationobj,
                        	width: '100%',
                            height: '40%',
                            source: dataAdapter,
                            columnsresize: true,
                            sortable: true,
                            filterable: true,
                            pageable: true,
                            pagermode: 'simple',
                            pagesize: 25,
                            theme: 'web',
                            autoshowfiltericon: true,
                            
                            columns: [
       	                              
        	                        {text: '', datafield: 'Editar', columntype: 'button', cellsrenderer: function () {
        	                        	
        	                        	return 'Editar';
        	                        },
        	                        buttonclick: function (row) {
       	                        	
        	                        	resetForm("#form1");

        		                        var dataRecord = $("#jqxgrid").jqxGrid('getrowdata', row);        	                        	
        		                        
        		        	    		$("#nome").val(dataRecord.nome); 
        		        	    		$("#login").val(dataRecord.login); 
        		                    	$("#ativo").jqxComboBox('val',dataRecord.ativo); 
        		                    	$("#tipo").jqxComboBox('val',dataRecord.tipo);
        		                    	//$("#grupo").jqxComboBox('val',dataRecord.grupo); 
        		                    	//$("#permitir").jqxComboBox('val',dataRecord.permitir);

        		                    	var ccs = dataRecord.listaCC_delimitado.split(",");
        	        		                    	
        		                    	for(var iA = 0; iA < ccs.length; iA++){
        		                    		
            		    					$("div[data-app='check_cc']").each(function(iB,obj){
    		    						
            		    						if($(obj).context.textContent == ccs[iA]){
            		    							$(obj).jqxCheckBox('check');
            		    						}
            		    					});
        		                    	}
        		                    	
        		                    	
        		                    	var grupos = dataRecord.grupos_delimitado.split(",");
        		                    	
        		                    	for(var iA = 0; iA < grupos.length; iA++){
        		                    		
            		    					$("div[data-app='check_gr']").each(function(iB,obj){
    		    						
            		    						if($(obj).context.textContent == grupos[iA]){
            		    							$(obj).jqxCheckBox('check');
            		    						}
            		    					});
        		                    	}
        	                   		}
        	                   	}, 
        	                   	
        	                    { text: '', datafield: 'Excluir', columntype: 'button',cellsrenderer: function () {
        							return "Excluir";
        						},
        							buttonclick: function (row) {
 
        								alert("Função não disponível.");
        								
        								//excluir(dataRecord.id);
        							}
        						},                    	
        	                  	    
        	               		//demais colunas da grid
        	                    { text: 'Nome', datafield: 'nome', width: 250,filtertype: 'input', cellsalign: 'left'},
        	                    { text: 'Login', datafield: 'login',width: 200,filtertype: 'input',cellsalign: 'left'},
        	                    { text: 'Grupos', datafield: 'grupos_delimitado',width: 250,hidden:true},
        	                    { text: 'Tipo', datafield: 'tipo',width: 250,filtertype: 'checkedlist',cellsalign: 'center'},
        	                    { text: 'Ativo', datafield: 'ativo',width: 60, filtertype: 'checkedlist', cellsalign: 'center'},
        	                    //{ text: 'Permitir Acesso', datafield: 'permitirAcesso',width : 90, filtertype: 'checkedlist', cellsalign: 'center'},
        	                    { text: 'CC Autorizados', datafield: 'listaCC_delimitado',width: 60, filtertype: 'checkedlist', cellsalign: 'center',hidden:true},
                            ]    
                        });                
                
                $('#jqxgrid').on('bindingcomplete',addImageButton);
                $('#jqxgrid').on('filter',addImageButton);
                $("#jqxgrid").on("columnresized", addImageButton); 
                $("#jqxgrid").on("columnreordered",addImageButton); 
                $("#jqxgrid").on("sort",addImageButton);
                $("#jqxgrid").on("pagechanged", addImageButton);
                
                
                function addImageButton(){
                	
                	
    	            $(":input[type='button']").each(function(i,obj){
    	            	
    	            	if($(obj).context.value == "Editar" || $(obj).context.value == "Excluir"){
    	            		
    	            		$(obj).context.type = "image";
    	            		
    	            		if($(obj).context.value == "Editar"){
    	            			
    	            			$(obj).context.src = "img/edit.png";
    	            		}
    	            		else if($(obj).context.value == "Excluir"){
    	            			
    	            			$(obj).context.src = "img/delete.png";
    	            		}
    	            	}
    	            });
                }
                
                
                $(window).resize(function() {
                	addImageButton();
                });
                
                var resizeTimer = 100;

                $(window).on('resize', function(e) {

                  clearTimeout(resizeTimer);
                  resizeTimer = setTimeout(function() {

                    addImageButton();
                            
                  }, 250);

                });
                
	    	});
	    </script>
	</head>
	    <body>
	    
		<div style="width: 100%">
			<img src="../img/constran_logo.png">
		</div>
	    <div id="content" style="">
	        <div id="jqxMenu">
				<ul>
	                <li><a href="#" onclick="window.history.back();">Voltar</a></li>
	                <li><a href="#" onclick="logoff();">Sair</a></li>
	            </ul>
	        </div>	    
	    
	    	<br/>
    		<form id="form1" style="float:left; width: 30%; overflow-y: scroll; height: 400px;">
    		
    		 <input type="hidden" id="_id_login" value="-1">
    		
			 <fieldset style="">
			  <legend>Cadastro de Usuários</legend>
				
					<label>Nome</label>
					<input type="text" id="nome">
					<br/>
					
					<label>Login</label>
					<input type="text" id="login">
					<br/>
					
					
					<label>Senha</label>
					<input type="text" id="senha">
					<br/>
	
					<label>Ativo</label>
					<select name="" id="ativo">
						<option value="S">S</option>
						<option value="N">N</option>
					</select>
					
					
					<label>Tipo</label>
					<select name="" id="tipo">
					</select>
				
<!-- 					<label>Grupo</label>
					<select name="" id="grupo">
					</select> -->
					
<!-- 					<label>Permitir</label>
					<select name="" id="permitir">
					<option value="S">S</option>
					<option value="N">N</option>
					</select> -->
					<br/>
					
					<label>Grupos</label><br/>
					<div style="overflow-y: scroll; height: 100px; width: 207px;" id="listaGR">
				
					</div>
				
					<br/>
					
					<label>Centros de Custos</label><br/>
					<div style="overflow-y: scroll; height: 100px; width: 207px;" id="listaCC">
				
					</div>
			    

				<br/>
				  <input style="margin-right: 5px;" type="button" id="salvaUSR" value="Salvar"/>
                  <input id="cancelaSalvaUSR" type="button" value="Cancelar" />


			 </fieldset>
			</form>	    
   
			<br/>
		    <div id='jqxWidget' style="float:left; width: 65%;margin-left: 10px;">
		        <div id="jqxgrid"></div>
		    </div>
	    
	    </div>
		
	    <script>
			function logoff(){
				if(confirm("Você será desconectado...")){  
					ajxRequestStd({returnType:"json", async:false, timeout:10000, method:"GET", url:"../ws/restrito/login/logoff"}, 
						function(response){
							window.location.href = response.serverMessageUser
						}
					);
				}
			}			
	    </script>	
	    
	    <div id="erroMsg"></div>	
		<div class="footer">
		    <p>
		        © Todos os direitos reservados à <a href="http://www.constran.com.br">Constran</a>. Departamento de Tecnologia da Informação <a href='mailto:ti.matriz@constran.com.br'>ti.matriz@constran.com.br</a>. Versão 1.0.0
		    </p>
		</div>
			    
	    </body>
</html>